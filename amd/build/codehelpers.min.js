function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}define("qtype_coderunnerex/codehelpers",["qtype_coderunnerex/localresmanager"],(function(_ref){let{localResManager:localResManager}=_ref;class CodeHelperHistoryDisplayMode{}_defineProperty(CodeHelperHistoryDisplayMode,"SHOWN_SESSION",0),_defineProperty(CodeHelperHistoryDisplayMode,"SHOWN_ALL",1),_defineProperty(CodeHelperHistoryDisplayMode,"SHOWN_ACTIVE",2);class AiHelperDataRecord{constructor(id,_ref2){let{userQuestion:userQuestion=null,response:response=null,userRating:userRating=null,dbId:dbId=null,state:state=AiHelperDataRecord.STATE_PENDING}=_ref2;this._id=id,this.update({userQuestion:userQuestion,response:response,userRating:userRating,dbId:dbId,state:state}),this._onupdate=null}update(_ref3){let{id:id,userQuestion:userQuestion,response:response,userRating:userRating,dbId:dbId,state:state}=_ref3;void 0!==id&&(this._id=id),void 0!==dbId&&(this._dbId=dbId),void 0!==userQuestion&&(this._userQuestion=userQuestion),void 0!==response&&(this._response=response),void 0!==userRating&&(this._userRating=userRating),void 0!==state&&(this._state=state),this.onupdate&&this.onupdate(this)}get id(){return this._id}set id(value){this._id=value}get dbId(){return this._dbId}set dbId(value){this._dbId=value}get userQuestion(){return this._userQuestion}get response(){return this._response}get userRating(){return this._userRating}get state(){return this._state}get onupdate(){return this._onupdate}set onupdate(callback){this._onupdate=callback}}_defineProperty(AiHelperDataRecord,"STATE_PENDING",0),_defineProperty(AiHelperDataRecord,"STATE_REJECTED",-1),_defineProperty(AiHelperDataRecord,"STATE_FULFILLED",1);class AiHelperDataRecordList{constructor(){this._data=[],this._onupdate=null}_reactRecordUpdate(record){this._onupdate&&this._onupdate(record.id,record)}getRecordById(id){return this._data.find((record=>record.id===id))}push(id,_ref4){let{dbId:dbId=null,userQuestion:userQuestion=null,response:response=null,userRating:userRating=null,state:state=AiHelperDataRecord.STATE_PENDING}=_ref4;if(!id){id=Date.now()+"-"+this.length}const data=new AiHelperDataRecord(id,{dbId:dbId,userQuestion:userQuestion,response:response,userRating:userRating,state:state});return this._data.push(data),data.onupdate=this._reactRecordUpdate.bind(this),data.onupdate(data),data.id}updateRecord(oldId,_ref5){let{id:id,dbId:dbId,userQuestion:userQuestion,response:response,userRating:userRating,state:state}=_ref5;const record=this.getRecordById(oldId);return record?(void 0===id&&(id=oldId),record.update({id:id,dbId:dbId,userQuestion:userQuestion,response:response,userRating:userRating,state:state}),id):null}clear(){this._data=[]}get(index){return this._data[index]}get length(){return this._data.length}get data(){return this._data}get onupdate(){return this._onupdate}set onupdate(callback){this._onupdate=callback}}class UserRatingWidget{constructor(doc,parentElem){let rateOnlyOnce=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],initialValue=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;this._rateOnlyOnce=rateOnlyOnce,this._value=initialValue,this._createElems(doc).then((elem=>{this._elem=elem,parentElem&&parentElem.appendChild(this._elem)}))}async _createElems(doc){const result=doc.createElement("div");result.className="UserRatingWidget";const labelElem=doc.createElement("label");result.appendChild(labelElem);const ratingParent=doc.createElement("ul"),localStrings=await localResManager.getLocalStrings(["codehelper_user_rate_positive","codehelper_user_rate_negative","codehelper_user_rate_label_before_rating","codehelper_user_rate_label_after_rating"]);return[{value:1,text:localStrings.codehelper_user_rate_positive,title:localStrings.codehelper_user_rate_positive,className:"Positive"},{value:-1,text:localStrings.codehelper_user_rate_negative,title:localStrings.codehelper_user_rate_negative,className:"Negative"}].forEach((prop=>{const item=doc.createElement("li");item.classList.add("UserRatingLink"),item.classList.add(prop.className),item.setAttribute("data-value",prop.value),item.setAttribute("title",prop.title);const textElem=doc.createElement("span");textElem.innerText=prop.text,item.appendChild(textElem),ratingParent.appendChild(item),item.onclick=this._reactRateLinkClick.bind(this)})),result.appendChild(ratingParent),await this._updateWithRatingStatus(result),result}async _updateWithRatingStatus(targetElem){const localStrings=await localResManager.getLocalStrings(["codehelper_user_rate_label_before_rating","codehelper_user_rate_label_after_rating"]);if(targetElem||(targetElem=this._elem),!targetElem)return;this.isRated?(targetElem.classList.add("Rated"),targetElem.classList.remove("Unrated")):(targetElem.classList.add("Unrated"),targetElem.classList.remove("Rated"));targetElem.querySelector("label").innerText=this.isRated?localStrings.codehelper_user_rate_label_after_rating:localStrings.codehelper_user_rate_label_before_rating;targetElem.querySelectorAll(".UserRatingLink").forEach((link=>{parseInt(link.getAttribute("data-value"))===this.value?link.classList.add("Active"):link.classList.remove("Active")}))}_reactRateLinkClick(event){if(!this.isRated||!this.rateOnlyOnce){const target=event.currentTarget,rating=parseInt(target.getAttribute("data-value")),oldValue=this.value;oldValue!==rating&&(this.value=rating,this.onchange&&this.onchange(this,this.value,oldValue))}}get value(){return this._value}set value(rating){const newValue=parseInt(rating);newValue!==this.value&&(this._value=newValue,this._updateWithRatingStatus())}get rateOnlyOnce(){return this._rateOnlyOnce}set rateOnlyOnce(value){this._rateOnlyOnce=!!value}get isRated(){return!!this.value}}class CodeHelper{constructor(doc,_ref6){let{placeHolderId:placeHolderId,targetEditorId:targetEditorId,questionDataEmbedderId:questionDataEmbedderId,aiRequestUrl:aiRequestUrl,aiRateUrl:aiRateUrl,aiHelperPredefinedQuestions:aiHelperPredefinedQuestions,aiHelperRemainingUsageCount:aiHelperRemainingUsageCount,enableCustomQuestion:enableCustomQuestion,enableUserRating:enableUserRating,readOnly:readOnly,historyDisplayMode:historyDisplayMode,useSimpleMode:useSimpleMode}=_ref6;this._readOnly=readOnly,this._historyDisplayMode=historyDisplayMode,this._simpleMode=useSimpleMode,this._aiRequestUrl=aiRequestUrl,this._aiRateUrl=aiRateUrl,this._aiHelperPredefinedQuestions=aiHelperPredefinedQuestions||[],this._targetRawEditor=this._getTargetRawCodeEditorElem(doc,targetEditorId),this._targetEditor=this._getTargetCodeEditorWrapperElem(doc,targetEditorId),this._id=placeHolderId+"_cr_ex_codehelper",this._component={},this._qMetaData=this._retrieveQuestionMetaData(doc,questionDataEmbedderId),this._enableCustomQuestion=enableCustomQuestion,this._enableUserRating=enableUserRating,this._aiHelperRecords=new AiHelperDataRecordList,this._aiHelperRecords.onupdate=this.reactAiHelperRecordsUpdate.bind(this),this._aiHelperRecordsHistoryRetrieved=!1,this._createAndInsertWidget(doc,placeHolderId,{useSimpleMode:useSimpleMode,enableCustomQuestion:enableCustomQuestion}).then((()=>{this.aiHelperRemainingUsageCount=aiHelperRemainingUsageCount}))}_retrieveQuestionMetaData(doc,questionDataEmbedderId){const elem=doc.getElementById(questionDataEmbedderId);let result={};return elem&&(result.questionAttemptId=elem.getAttribute("data-question-attempt-id"),result.questionAttemptStepId=elem.getAttribute("data-question-attempt-step-id"),result.questionUsageId=elem.getAttribute("data-question-usage-id"),result.slot=elem.getAttribute("data-slot"),result.cmId=elem.getAttribute("data-cm-id")),result}_getTargetRawCodeEditorElem(doc,id){return doc.getElementById(id)}_getTargetCodeEditorWrapperElem(doc,rawId){const wrapperId=rawId+"_wrapper";return doc.getElementById(wrapperId)}async _createWidget(doc,_ref7){let{useSimpleMode:useSimpleMode,enableCustomQuestion:enableCustomQuestion}=_ref7;const self=this,localStrings=await localResManager.getLocalStrings(["codehelper_thumbnail_caption","codehelper_thumbnail_hint","codehelper_thumbnail_caption_simple_mode","codehelper_thumbnail_caption_simple_mode_hint","codehelper_collapsor_hint","codehelper_ask_submit_caption","codehelper_ask_submit_hint","codehelper_ask_input_placeholder","codehelper_ask_select_placeholder","err_code_helper_empty_ask","codehelper_ai_usage_count_reminder_hint","codehelper_user_rate_positive","codehelper_user_rate_negative"]),result=doc.createElement("section");result.className="CodeRunnerEx-CodeHelper Collapsed",useSimpleMode?result.classList.add("SimpleMode"):result.classList.add("NormalMode"),result.id=this.id,this.component.panel=result;const bgPanel=doc.createElement("div");bgPanel.className="BackgroundPanel outcome",result.appendChild(bgPanel);const inputSection=doc.createElement("div");inputSection.className="InputSection";const thumbnail=doc.createElement("button");thumbnail.className="Thumbnail btn btn-secondary";let innerTextElem=doc.createElement("span");innerTextElem.className="ButtonText",innerTextElem.innerHTML=useSimpleMode?localStrings.codehelper_thumbnail_caption_simple_mode:localStrings.codehelper_thumbnail_caption,thumbnail.appendChild(innerTextElem);let assocElem=doc.createElement("span");if(assocElem.className="ButtonAssoc",thumbnail.appendChild(assocElem),thumbnail.title=useSimpleMode?this._aiHelperPredefinedQuestions[0]||localStrings.codehelper_thumbnail_caption_simple_mode_hint:localStrings.codehelper_thumbnail_hint,thumbnail.onclick=e=>{e.preventDefault(),useSimpleMode?(this.isPanelExpanded()||this.startViewTransition(self.expandPanel.bind(self)),this.requestAiHelper()):this.startViewTransition(self.togglePanel.bind(self))},inputSection.appendChild(thumbnail),this.component.thumbnail=thumbnail,!useSimpleMode){if(!this.readOnly){const datalistContainer=doc.createElement("div");let inputter;if(datalistContainer.className="QInputContainer d-md-inline-block position-relative",enableCustomQuestion){const datalist=doc.createElement("datalist");datalist.id=this.id+"_input_datalist",(this._aiHelperPredefinedQuestions||[]).forEach((s=>{const option=doc.createElement("option");option.value=s,datalist.appendChild(option)})),datalistContainer.append(datalist),inputter=doc.createElement("input"),inputter.type="text",inputter.setAttribute("list",datalist.id),inputter.onkeypress=e=>{"Enter"===e.code&&(this.requestAiHelper(),e.preventDefault())},datalistContainer.appendChild(inputter)}else{inputter=doc.createElement("select");const selectorPlaceholder=doc.createElement("option");selectorPlaceholder.value="",selectorPlaceholder.innerText=localStrings.codehelper_ask_select_placeholder,selectorPlaceholder.setAttribute("disabled","disabled"),selectorPlaceholder.setAttribute("selected","selected"),inputter.appendChild(selectorPlaceholder),(this._aiHelperPredefinedQuestions||[]).forEach((s=>{const option=doc.createElement("option");option.value=s,option.innerText=s,inputter.appendChild(option)})),inputter.onchange=e=>{this.requestAiHelper(),e.preventDefault()},datalistContainer.appendChild(inputter)}inputter.className="QInput form-control",inputter.setAttribute("placeholder",localStrings.codehelper_ask_input_placeholder),inputSection.appendChild(datalistContainer),this.component.inputter=inputter}const btnSubmit=doc.createElement("button");btnSubmit.className="InputSubmitter btn btn-secondary",innerTextElem=doc.createElement("span"),innerTextElem.className="ButtonText",innerTextElem.innerHTML=localStrings.codehelper_ask_submit_caption,btnSubmit.appendChild(innerTextElem),btnSubmit.title=localStrings.codehelper_ask_submit_hint,btnSubmit.onclick=e=>{this.requestAiHelper(),e.preventDefault()},inputSection.appendChild(btnSubmit),this.component.submitter=btnSubmit}const usageCountReminder=doc.createElement("div");usageCountReminder.className="UsageCountReminder",this.component.submitter?inputSection.insertBefore(usageCountReminder,this.component.submitter):inputSection.appendChild(usageCountReminder),this.component.usageCountReminder=usageCountReminder,result.appendChild(inputSection);const responder=doc.createElement("div");responder.className="Responder";const responderContent=doc.createElement("p");if(responderContent.className="ResponderContent",responder.appendChild(responderContent),result.appendChild(responder),this.component.responder=responder,this.component.responderContent=responderContent,this.inSimpleMode){const panelToggler=doc.createElement("div");panelToggler.className="PanelToggler",panelToggler.title=localStrings.codehelper_thumbnail_hint,panelToggler.onclick=e=>{this.startViewTransition(self.togglePanel.bind(self))},result.appendChild(panelToggler)}return result}_insertWidgetToDom(doc,widgetElem,placeHolder){placeHolder.parentNode.replaceChild(widgetElem,placeHolder)}async _createAndInsertWidget(doc,placeHolderId,_ref8){let{useSimpleMode:useSimpleMode,enableCustomQuestion:enableCustomQuestion}=_ref8,placeHolder=doc.getElementById(placeHolderId);if(placeHolder){let elem=await this._createWidget(doc,{useSimpleMode:useSimpleMode,enableCustomQuestion:enableCustomQuestion});this._insertWidgetToDom(doc,elem,placeHolder)}}startViewTransition(func){for(var _len=arguments.length,args=new Array(_len>1?_len-1:0),_key=1;_key<_len;_key++)args[_key-1]=arguments[_key];if(document.startViewTransition){document.startViewTransition((()=>func(...args)))}else func(...args)}expandPanel(){if(this.component.panel.classList.remove("Collapsed"),this.component.panel.classList.add("Expanded"),this.component.inputter&&this.component.inputter.focus(),!this._aiHelperRecordsHistoryRetrieved&&this.historyDisplayMode===CodeHelperHistoryDisplayMode.SHOWN_ALL)try{this.requestAiHelperHistoryData()}finally{this._aiHelperRecordsHistoryRetrieved=!0}}collapsePanel(){this.component.panel.classList.add("Collapsed"),this.component.panel.classList.remove("Expanded")}togglePanel(){this.isPanelExpanded()?this.collapsePanel():this.expandPanel()}isPanelExpanded(){return!this.component.panel.classList.contains("Collapsed")}_stripHtmlTags(content,doc){if(!doc){doc=this.component.responderContent.ownerDocument}const dummyElem=doc.createElement("div");return dummyElem.innerHTML=content,dummyElem.innerText}_jsonToFormData(jsonObj){let result=new FormData;for(let key of Object.keys(jsonObj)){let value=jsonObj[key];if(value instanceof Array)for(let item of value)result.append(key,item);else result.append(key,value)}return result}outputLines(lines,outputElem){outputElem||(outputElem=this.component.responderContent);const doc=outputElem.ownerDocument,docFrag=doc.createDocumentFragment();lines.forEach((line=>{const elem=doc.createElement("div");elem.innerText=line||" ",docFrag.appendChild(elem)})),outputElem.appendChild(docFrag),setTimeout((()=>{const scrollElem=this.component.responder;scrollElem.scrollTo({top:scrollElem.scrollHeight,behavior:"smooth"})}),10)}outputSection(sectionLines,outputType){const parent=this.component.responderContent,sectionElem=parent.ownerDocument.createElement("section");sectionElem.className="ResponderSection",this.outputLines(sectionLines,sectionElem),parent.appendChild(sectionElem)}getEmulatedResponseTextLines(){let result=[];result.push("服务器返回的回答将在这里显示。"),result.push(""),result.push("注意：当前不会完成实际工作，仅是模拟AI helper的输出。"),result.push("与题目相关的以下各项数据将被发送至服务器，进而获取服务器响应："),result.push(""),result.push("[Current answer]");const answer=this.currAnswer||"<empty>";result=result.concat(answer.split("\n")),result.push("[Question]");const sQuestion=JSON.stringify(this.questionData,null,"  ");result=result.concat(sQuestion.split("\n")),result.push("[Last Attempt]");const sAttempt=JSON.stringify(this.lastAttemptData,null,"  ");return result=result.concat(sAttempt.split("\n")),result.push("[Output End]"),result}emulateResponse(){const batchLineCount_min=3,batchLineCount_max=7,batchDuration_min=500,batchDuration_max=1500,outputLines=this.getEmulatedResponseTextLines();let currLineIndex=0,self=this;!function responseStep(){const lineCount=Math.round(Math.random()*(batchLineCount_max-batchLineCount_min))+batchLineCount_min,delay=Math.round(Math.random()*(batchDuration_max-batchDuration_min))+batchDuration_min;setTimeout((()=>{const lines=outputLines.slice(currLineIndex,currLineIndex+lineCount);self.outputLines(lines),currLineIndex+=lineCount,currLineIndex<outputLines.length&&responseStep()}),delay)}()}async requestAiHelper_old(){let userQuestion=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";if(userQuestion||(userQuestion=this.component.inputter.value),this.aiRequestUrl){const data={questionBody:this._stripHtmlTags(this.questionData.questiontext),questionLanguage:this.questionData.language,testCases:this.questionData.testcases,userCode:this.currAnswer,userQuestion:userQuestion,omitCodeSnippet:!0};let response=await fetch(this.aiRequestUrl,{method:"post",headers:{"Content-Type":"application/json;charset=utf-8"},body:JSON.stringify(data)});if(response.ok){const result=await response.json();if(result.success){const output=result.result.response;this.outputSection(output.split("\n"))}else console.error(result.message),this.outputSection([result.message],"Error")}else console.error("Fetch failed"),this.outputSection(["Fetch failed"],"Error")}}async requestAiHelper(){if(this.readOnly)return;const localStrings=await localResManager.getLocalStrings(["err_code_helper_empty_ask","err_code_helper_server_fetch_failed","err_code_helper_usage_count_exceeded"]);if(this.isAiHelperUsageCountExceeded())return void await this.pushAiHelperRecord({id:null,userQuestion:"",response:localStrings.err_code_helper_usage_count_exceeded,state:AiHelperDataRecord.STATE_REJECTED});const userQuestion=this.inSimpleMode?this._aiHelperPredefinedQuestions[0]:this.component.inputter&&this.component.inputter.value,userQuestionIndex=!this.enableCustomQuestion&&this.component.inputter?this.component.inputter.selectedIndex-1:null;if(userQuestion||userQuestionIndex){if(this.aiRequestUrl){if(this.requestAiHelper.isFetching)return;this.requestAiHelper.isFetching=!0;const data={cm:this.questionData.cmId,question_attempt:this.questionData.questionAttemptId,question_attempt_step:this.questionData.questionAttemptStepId,question_usage:this.questionData.questionUsageId,slot:this.questionData.slot,user_code:this.currAnswer,omitCodeSnippet:!0};this._enableCustomQuestion?data.user_question=userQuestion:data.user_question_index=userQuestionIndex;const currAiHelperRecordId=await this.pushAiHelperRecord({id:null,userQuestion:userQuestion});try{let response=await fetch(this.aiRequestUrl,{method:"post",credentials:"include",body:this._jsonToFormData(data)});if(response.ok){const result=await response.json();if(result.success){const output=result.result.response,newResponseId=null!==result.result.id||void 0!==result.result.id?result.result.id:void 0;this.updateAiHelperRecord(currAiHelperRecordId,{dbId:newResponseId,response:output,state:AiHelperDataRecord.STATE_FULFILLED})}else console.error(result.message),this.updateAiHelperRecord(currAiHelperRecordId,{response:result.message,state:AiHelperDataRecord.STATE_REJECTED});result.result&&"number"==typeof result.result.remainingUsageCount?this.aiHelperRemainingUsageCount=result.result.remainingUsageCount:this.decreaseRemainingUsageCount()}else console.error(localStrings.err_code_helper_server_fetch_failed),this.updateAiHelperRecord(currAiHelperRecordId,{response:localStrings.err_code_helper_server_fetch_failed,state:AiHelperDataRecord.STATE_REJECTED})}catch(e){console.error(e.message),this.updateAiHelperRecord(currAiHelperRecordId,{response:e.message,state:AiHelperDataRecord.STATE_REJECTED})}finally{this.requestAiHelper.isFetching=!1}}}else await this.pushAiHelperRecord({id:null,userQuestion:"",response:localStrings.err_code_helper_empty_ask,state:AiHelperDataRecord.STATE_REJECTED})}async rateAiHelperResponse(id,responseDbId,value){if(this.aiRateUrl){const localStrings=await localResManager.getLocalStrings(["err_code_helper_server_fetch_failed"]),data={question_usage:this.questionData.questionUsageId,slot:this.questionData.slot,id:responseDbId,value:value,mode:"set"};let response=await fetch(this.aiRateUrl,{method:"post",credentials:"include",body:this._jsonToFormData(data)});if(!response.ok)throw new Error(localStrings.err_code_helper_server_fetch_failed);{const result=await response.json();if(!result.success)throw new Error(result.message);{const newRate=result.result;console.log("rated",responseDbId,newRate),this.updateAiHelperRecord(responseDbId,{userRating:newRate})}}}}async requestAiHelperHistoryData(){if(this.aiRequestUrl){const data={cm:this.questionData.cmId,question_attempt:this.questionData.questionAttemptId,question_attempt_step:this.questionData.questionAttemptStepId,question_usage:this.questionData.questionUsageId,slot:this.questionData.slot,history:!0};let response=await fetch(this.aiRequestUrl,{method:"post",credentials:"include",body:this._jsonToFormData(data)});if(response.ok){const result=await response.json();if(result.success){const historyItems=result.result||[];historyItems.sort(((a,b)=>a.timestamp-b.timestamp));const historyRecords=historyItems.map(((item,index)=>{const id=void 0===item.id?"his-"+index:item.id;return new AiHelperDataRecord(id,{dbId:item.id,userQuestion:item.user_question,response:item.response,userRating:item.user_rating,state:AiHelperDataRecord.STATE_FULFILLED})}));this._aiHelperRecords.data.unshift(...historyRecords),await this.repaintAiHelperRecords(),!historyItems.length&&this.readOnly&&localResManager.getLocalStrings(["codehelper_no_history_item"]).then((localStrings=>{this.pushAiHelperRecord({id:null,userQuestion:"",response:localStrings.codehelper_no_history_item,state:AiHelperDataRecord.STATE_FULFILLED})}))}else console.error(result.message)}else console.error(localStrings.err_code_helper_server_fetch_failed),this.updateAiHelperRecord(currAiHelperRecordId,{response:localStrings.err_code_helper_server_fetch_failed,state:AiHelperDataRecord.STATE_REJECTED})}}decreaseRemainingUsageCount(){this.readOnly||"number"==typeof this.aiHelperRemainingUsageCount&&this.aiHelperRemainingUsageCount>0&&this.aiHelperRemainingUsageCount--}async pushAiHelperRecord(_ref9){let{id:id,dbId:dbId,userQuestion:userQuestion=null,response:response=null,state:state=AiHelperDataRecord.STATE_PENDING}=_ref9;return this.historyDisplayMode===CodeHelperHistoryDisplayMode.SHOWN_ACTIVE&&(this._aiHelperRecords.clear(),await this.repaintAiHelperRecords()),this._aiHelperRecords.push(id,{dbId:dbId,userQuestion:userQuestion,response:response,state:state})}updateAiHelperRecord(id,_ref10){let{dbId:dbId,userQuestion:userQuestion,response:response,state:state}=_ref10;return this._aiHelperRecords.updateRecord(id,{dbId:dbId,userQuestion:userQuestion,response:response,state:state})}async repaintAiHelperRecords(){this._component.responderContent.innerHTML="";for(let record of this._aiHelperRecords.data)await this.updateAiHelperRecordOnElem(record.id,record);this.requestScrollToResponderBottom()}async reactAiHelperRecordsUpdate(id,record){await this.updateAiHelperRecordOnElem(id,record),this.requestScrollToResponderBottom()}requestScrollToResponderBottom(){setTimeout((()=>{const scrollElem=this.component.responder;scrollElem.scrollTo({top:scrollElem.scrollHeight,behavior:"smooth"})}),10)}_needToDisplayAiHelperRecordUserAskedQuestion(){return!(this.historyDisplayMode===CodeHelperHistoryDisplayMode.SHOWN_ACTIVE&&this.inSimpleMode)}async updateAiHelperRecordOnElem(recordId,record){const rootElem=this._component.responderContent,doc=rootElem.ownerDocument;let recordElem=rootElem.querySelector('section[data-record-id="'.concat(recordId,'"]'));if(!recordElem){if(recordElem=doc.createElement("section"),recordElem.setAttribute("data-record-id",recordId),this._needToDisplayAiHelperRecordUserAskedQuestion()){const elemUserQuestion=doc.createElement("p");elemUserQuestion.className="UserQuestion comment",recordElem.appendChild(elemUserQuestion)}const elemResponse=doc.createElement("p");if(elemResponse.className="Response",recordElem.appendChild(elemResponse),this.enableUserRating||this.enableViewUserRating){const elemUserRating=doc.createElement("div");elemUserRating.className="UserRating";await localResManager.getLocalStrings(["codehelper_user_rate_positive","codehelper_user_rate_negative"]);const ratingWidget=new UserRatingWidget(doc,elemUserRating,!0);ratingWidget.onchange=async(widget,newValue,oldValue)=>{try{await this.rateAiHelperResponse(record.id,record.dbId,newValue)}catch(e){ratingWidget.value=oldValue,console.error(e)}},recordElem._ratingWidget=ratingWidget,recordElem.appendChild(elemUserRating)}rootElem.appendChild(recordElem)}{const hasDbId=record.dbId||0===record.dbId;hasDbId?recordElem.setAttribute("data-db-id",record.dbId):recordElem.removeAttribute("data-db-id");const elemUserQuestion=recordElem.getElementsByClassName("UserQuestion comment")[0];elemUserQuestion&&(elemUserQuestion.innerText=record.userQuestion,record.userQuestion?elemUserQuestion.classList.remove("Hide"):elemUserQuestion.classList.add("Hide"));const elemResponse=recordElem.getElementsByClassName("Response")[0];this._updateAiHelperResponseOnElem(doc,elemResponse,record.response);const elemUserRating=recordElem.getElementsByClassName("UserRating")[0];elemUserRating&&this.startViewTransition((()=>{record.state===AiHelperDataRecord.STATE_FULFILLED&&hasDbId&&(this.enableUserRating||this.enableViewUserRating&&record.userRating)?elemUserRating.classList.remove("Hide"):elemUserRating.classList.add("Hide"),recordElem._ratingWidget&&(recordElem._ratingWidget.value=record.userRating)}))}const elemStateClass=record.state===AiHelperDataRecord.STATE_PENDING?"Pending":record.state===AiHelperDataRecord.STATE_REJECTED?"Rejected":"Fulfilled";recordElem.className="ResponderSection "+elemStateClass}_updateAiHelperResponseOnElem(doc,elemResponse,response){if(response)if("object"!=typeof response)elemResponse.innerText=response;else{elemResponse.innerText="";for(let section of response){if(!section)continue;const elemSection=doc.createElement("section");if(elemSection.className="ResponseSection",section.title){const elemTitle=doc.createElement("h3");elemTitle.className="ResponseSectionTitle",elemTitle.innerText=section.title,elemSection.appendChild(elemTitle)}if(section.contents){const elemContent=doc.createElement("div");if(elemContent.className=section.is_code_snippet?"ResponseSectionCode":"ResponseSectionContent",section.is_code_omitted&&(elemContent.className+=" ResponseSectionCodeOmitted"),elemContent.innerText=section.contents.join("\n"),elemSection.appendChild(elemContent),section.is_code_snippet&&!section.is_code_omitted&&window.ace){const aceOptions={selectionStyle:"text",readOnly:!0,minLines:2,maxLines:999};section.code_language&&(aceOptions.mode=this._getAceEditorModeOption(section.code_language)),setTimeout((()=>{window.ace.edit(elemContent,aceOptions).session.setValue(section.contents.join("\n")+"\n")}),50)}}elemResponse.appendChild(elemSection)}}else elemResponse.innerText=""}_getAceEditorModeOption(codeSectionLanguage){return"ace/mode/"+({nodejs:"javascript",js:"javascript",python3:"python",python2:"python",delphi:"pascal"}[codeSectionLanguage]||codeSectionLanguage)}isAiHelperUsageCountExceeded(){const value=this.aiHelperRemainingUsageCount;return"number"==typeof value&&value<=0}get id(){return this._id}get targetEditor(){return this._targetEditor||this._targetRawEditor}get component(){return this._component}get enableUserRating(){return this._enableUserRating&&!this.readOnly}get enableViewUserRating(){return this.enableUserRating||this.readOnly}get readOnly(){return this._readOnly}get historyDisplayMode(){return this.readOnly?CodeHelperHistoryDisplayMode.SHOWN_ALL:this._historyDisplayMode}get inSimpleMode(){return this._simpleMode}get currAnswer(){var _this$_targetRawEdito;return null===(_this$_targetRawEdito=this._targetRawEditor)||void 0===_this$_targetRawEdito?void 0:_this$_targetRawEdito.value}get questionData(){return this._qMetaData}get lastAttemptData(){return[]}get aiRequestUrl(){return this._aiRequestUrl}get aiRateUrl(){return this._aiRateUrl}get aiHelperRemainingUsageCount(){return this._aiHelperRemainingUsageCount}set aiHelperRemainingUsageCount(value){if(this._aiHelperRemainingUsageCount=value,"number"==typeof value){if(this.component.usageCountReminder){const displayedValue=value>99?"99+":value;this.component.usageCountReminder.classList.remove("Hidden"),this.component.usageCountReminder.innerText=displayedValue,localResManager.getLocalStrings(["codehelper_ai_usage_count_reminder_hint"]).then((localStrings=>{this.component.usageCountReminder.title=localStrings.codehelper_ai_usage_count_reminder_hint.replace("{}",value)}))}this.component.submitter&&(this.component.submitter.disabled=this.isAiHelperUsageCountExceeded()),this.component.inputter&&(this.component.inputter.disabled=this.isAiHelperUsageCountExceeded())}else this.component.usageCountReminder&&this.component.usageCountReminder.classList.add("Hidden")}}return{CodeHelper:CodeHelper,init:function(_ref11){let{codeHelperPlaceHolderId:codeHelperPlaceHolderId,questionMetaElemId:questionMetaElemId,targetEditorId:targetEditorId,codeHelperInSimpleMode:codeHelperInSimpleMode,aiHelperRequestUrl:aiHelperRequestUrl,aiHelperRateUrl:aiHelperRateUrl,aiHelperPredefinedQuestions:aiHelperPredefinedQuestions,aiHelperRemainingUsageCount:aiHelperRemainingUsageCount,historyDisplayMode:historyDisplayMode,enableCustomQuestion:enableCustomQuestion,enableUserRating:enableUserRating,readOnly:readOnly}=_ref11;return new CodeHelper(document,{placeHolderId:codeHelperPlaceHolderId,targetEditorId:targetEditorId,questionDataEmbedderId:questionMetaElemId,aiRequestUrl:aiHelperRequestUrl,aiRateUrl:aiHelperRateUrl,aiHelperPredefinedQuestions:aiHelperPredefinedQuestions,aiHelperRemainingUsageCount:aiHelperRemainingUsageCount,enableCustomQuestion:enableCustomQuestion,enableUserRating:enableUserRating,readOnly:readOnly,historyDisplayMode:historyDisplayMode,useSimpleMode:codeHelperInSimpleMode})}}}));

//# sourceMappingURL=codehelpers.min.js.map